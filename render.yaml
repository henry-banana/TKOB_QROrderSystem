services:
  # ============================================
  # Backend API Service (FREE TIER)
  # ============================================
  - type: web
    name: tkob-api
    runtime: docker
    region: singapore # Chọn: oregon, frankfurt, singapore
    plan: free # ✅ FREE PLAN - 750 hours/month, sleep after 15min idle
    branch: main
    rootDir: source/apps/api
    dockerfilePath: ./Dockerfile
    dockerContext: ../../..

    # Environment Variables
    envVars:
      - key: NODE_ENV
        value: production

      - key: API_PORT
        value: 3000

      # ⚠️ DATABASE: Dùng Neon - paste connection string từ Neon dashboard
      # Format: postgresql://user:pass@ep-xxx.neon.tech/dbname?sslmode=require
      - key: DATABASE_URL
        sync: false # Không sync, nhập manual trên dashboard

      # ⚠️ JWT: Generate bằng: openssl rand -base64 32
      - key: JWT_SECRET
        generateValue: true

      - key: JWT_EXPIRES_IN
        value: 7d

      # ⚠️ REDIS: Dùng Upstash Redis (free tier)
      # Lấy từ: https://console.upstash.com/
      - key: REDIS_HOST
        sync: false # Nhập manual

      - key: REDIS_PORT
        value: 6379

      # Optional: Nếu Upstash yêu cầu password
      - key: REDIS_PASSWORD
        sync: false

      # Frontend URLs (sẽ update sau khi deploy Vercel)
      - key: CUSTOMER_APP_URL
        value: https://your-customer-app.vercel.app

      - key: CORS_ORIGINS
        value: https://your-customer-app.vercel.app,https://your-admin-app.vercel.app

      - key: LOG_LEVEL
        value: info

    # Auto-deploy khi push code
    buildFilter:
      paths:
        - source/apps/api/**

    # Health check endpoint
    healthCheckPath: /health

    # Enable auto-deploy
    autoDeploy: true
